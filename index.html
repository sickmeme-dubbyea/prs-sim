<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PRS Stage & Match Builder</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Barlow+Condensed:wght@400;600;700;900&display=swap" rel="stylesheet">
<style>
  /* ══ THEME: AMBER TACTICAL (default) ══ */
  :root, [data-theme="amber"] {
    --bg: #0d0f0c;
    --surface: #131610;
    --surface2: #1a1e17;
    --border: #2e3528;
    --border-bright: #4a5540;
    --accent: #c8922a;
    --accent-bright: #e8a832;
    --accent-dim: #7a5518;
    --accent2: #5a7a3a;
    --accent2-bright: #7aaa4a;
    --text: #c8cfc0;
    --text-dim: #6a7560;
    --text-bright: #e8efe0;
    --red: #8a3a2a;
    --red-bright: #c85a3a;
    --scanline-color: rgba(0,0,0,0.08);
    --glow: none;
  }

  /* ══ THEME: NIGHT VISION GREEN ══ */
  [data-theme="nvg"] {
    --bg: #010c01;
    --surface: #020f02;
    --surface2: #041504;
    --border: #0a2a0a;
    --border-bright: #164916;
    --accent: #00c800;
    --accent-bright: #39ff39;
    --accent-dim: #006000;
    --accent2: #00a000;
    --accent2-bright: #20e020;
    --text: #90e890;
    --text-dim: #2a7a2a;
    --text-bright: #c8ffc8;
    --red: #003000;
    --red-bright: #00b800;
    --scanline-color: rgba(0,40,0,0.18);
    --glow: 0 0 8px rgba(0,200,0,0.25);
  }

  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'Share Tech Mono', monospace;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    overflow-x: hidden;
  }

  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background: repeating-linear-gradient(0deg, transparent, transparent 2px, var(--scanline-color) 2px, var(--scanline-color) 4px);
    pointer-events: none;
    z-index: 9000;
  }

  /* ── NVG GLOW EFFECTS ── */
  [data-theme="nvg"] header { box-shadow: 0 2px 24px rgba(0,200,0,0.12); }
  [data-theme="nvg"] .gen-btn { box-shadow: 0 0 14px rgba(0,200,0,0.3); }
  [data-theme="nvg"] .shot-chip { box-shadow: 0 0 4px rgba(0,200,0,0.2); }
  [data-theme="nvg"] .stage-card { box-shadow: 0 0 10px rgba(0,100,0,0.2); }
  [data-theme="nvg"] .status-dot { box-shadow: 0 0 8px rgba(57,255,57,0.9); }
  [data-theme="nvg"] input[type="number"]:focus,
  [data-theme="nvg"] select:focus { box-shadow: 0 0 0 2px rgba(0,200,0,0.2), 0 0 10px rgba(0,200,0,0.12); }
  [data-theme="nvg"] .reticle svg { filter: drop-shadow(0 0 4px rgba(0,255,0,0.55)); }
  [data-theme="nvg"] .stage-num { text-shadow: 0 0 10px rgba(57,255,57,0.4); }

  /* ══ THEME: DAYTIME ══ */
  [data-theme="day"] {
    --bg: #f5f5f3;
    --surface: #ffffff;
    --surface2: #ebebea;
    --border: #d0d0cc;
    --border-bright: #aaaaaa;
    --accent: #1a1a1a;
    --accent-bright: #000000;
    --accent-dim: #555555;
    --accent2: #3a3a3a;
    --accent2-bright: #111111;
    --text: #1a1a1a;
    --text-dim: #888888;
    --text-bright: #000000;
    --red: #cccccc;
    --red-bright: #cc2200;
    --scanline-color: rgba(0,0,0,0.0);
    --glow: none;
  }

  /* ── DAYTIME OVERRIDES ── */
  [data-theme="day"] header { border-bottom-color: #1a1a1a; }
  [data-theme="day"] header::before { background: linear-gradient(90deg, transparent, #555, transparent); }
  [data-theme="day"] .sidebar { border-right-color: var(--border); }
  [data-theme="day"] .gen-btn { background: #1a1a1a; color: #ffffff; }
  [data-theme="day"] .gen-btn:hover { background: #333333; }
  [data-theme="day"] .gen-btn:active { background: #555555; }
  [data-theme="day"] .shot-chip { background: rgba(0,0,0,0.06); border-color: #aaa; color: #111; }
  [data-theme="day"] .stage-card { border-color: var(--border); }
  [data-theme="day"] .stage-header { background: #ebebea; }
  [data-theme="day"] .mode-tabs label:has(input:checked) { background: rgba(0,0,0,0.08); border-color: #888; }
  [data-theme="day"] .cb-label:has(input:checked) .cb-box { background: #1a1a1a; border-color: #000; }
  [data-theme="day"] .cb-label:has(input:checked) { border-color: #888; }
  [data-theme="day"] .dist-toggle.active { background: #1a1a1a; border-color: #000; }
  [data-theme="day"] .modal { border-top-color: #1a1a1a; }
  [data-theme="day"] .help-btn { border-color: #aaa; }
  [data-theme="day"] .help-btn:hover { border-color: #333; color: #111; background: rgba(0,0,0,0.05); }
  [data-theme="day"] .badge-club { color: #2a7a2a; border-color: #5a9a5a; }
  [data-theme="day"] .badge-regional { color: #7a5a00; border-color: #aa8800; }
  [data-theme="day"] .badge-national { color: #cc2200; border-color: #cc2200; }
  [data-theme="day"] .status-dot { background: #2a7a2a; animation: none; opacity: 1; }
  [data-theme="day"] .reticle svg { filter: none; }
  [data-theme="day"] ::-webkit-scrollbar-track { background: #ebebea; }
  [data-theme="day"] ::-webkit-scrollbar-thumb { background: #c0c0bc; }
  [data-theme="day"] .meta-item span { color: #1a1a1a; }
  [data-theme="day"] .position-name { color: #1a1a1a; }


  /* ── HEADER ── */
  header {
    background: var(--surface);
    border-bottom: 2px solid var(--accent);
    position: relative;
    overflow: hidden;
    z-index: 100;
  }

  header::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 1px;
    background: linear-gradient(90deg, transparent, var(--accent-bright), transparent);
    animation: sweep 4s ease-in-out infinite;
  }

  @keyframes sweep {
    0%, 100% { opacity: 0; transform: translateX(-100%); }
    50%       { opacity: 1; transform: translateX(100%); }
  }

  .header-inner {
    display: flex;
    align-items: center;
    gap: 20px;
    padding: 16px 24px;
  }

  .reticle { width: 46px; height: 46px; flex-shrink: 0; }
  .reticle svg { width: 100%; height: 100%; animation: reticle-spin 20s linear infinite; }
  @keyframes reticle-spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

  .header-text h1 {
    font-family: 'Barlow Condensed', sans-serif;
    font-weight: 900;
    font-size: 1.9rem;
    letter-spacing: 0.12em;
    color: var(--accent-bright);
    text-transform: uppercase;
    line-height: 1;
  }

  .header-text p {
    font-size: 0.68rem;
    color: var(--text-dim);
    letter-spacing: 0.25em;
    margin-top: 4px;
  }

  .header-right {
    margin-left: auto;
    display: flex;
    align-items: center;
    gap: 16px;
  }

  .help-btn {
    background: transparent;
    border: 1px solid var(--border-bright);
    color: var(--text-dim);
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.68rem;
    letter-spacing: 0.2em;
    padding: 7px 14px;
    cursor: pointer;
    text-transform: uppercase;
    transition: all 0.2s;
  }

  .help-btn:hover {
    border-color: var(--accent);
    color: var(--accent-bright);
    background: rgba(200,146,42,0.08);
  }

  .header-status {
    text-align: right;
    font-size: 0.63rem;
    color: var(--text-dim);
    letter-spacing: 0.15em;
    line-height: 1.65;
  }

  .status-dot {
    display: inline-block;
    width: 7px; height: 7px;
    border-radius: 50%;
    background: var(--accent2-bright);
    margin-right: 5px;
    animation: pulse 2s ease-in-out infinite;
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50%       { opacity: 0.3; }
  }

  /* ── LAYOUT ── */
  .main-grid {
    display: grid;
    grid-template-columns: 360px 1fr;
    min-height: calc(100vh - 84px);
  }

  /* ── SIDEBAR ── */
  .sidebar {
    background: var(--surface);
    border-right: 1px solid var(--border);
    padding: 18px 16px;
    display: flex;
    flex-direction: column;
    gap: 6px;
    overflow-y: auto;
    max-height: calc(100vh - 84px);
  }

  .panel {
    background: var(--surface2);
    border: 1px solid var(--border);
    padding: 14px;
    transition: border-color 0.2s;
  }

  .panel:hover { border-color: var(--border-bright); }

  .panel-label {
    font-size: 0.58rem;
    letter-spacing: 0.3em;
    color: var(--accent);
    text-transform: uppercase;
    margin-bottom: 11px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .panel-label::after {
    content: '';
    flex: 1;
    height: 1px;
    background: var(--border);
  }

  .field-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 9px;
    gap: 8px;
  }

  .field-row:last-child { margin-bottom: 0; }

  label.field-label {
    font-size: 0.68rem;
    color: var(--text-dim);
    letter-spacing: 0.08em;
    white-space: nowrap;
  }

  input[type="number"], select {
    background: var(--bg);
    border: 1px solid var(--border);
    color: var(--accent-bright);
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.82rem;
    padding: 5px 9px;
    text-align: right;
    outline: none;
    width: 115px;
    transition: border-color 0.2s, box-shadow 0.2s;
    -webkit-appearance: none;
    appearance: none;
  }

  input[type="number"]:focus, select:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 2px rgba(200,146,42,0.15);
  }

  select { cursor: pointer; text-align: left; }
  select option { background: var(--surface2); color: var(--text); }

  /* ── MODE TABS ── */
  .mode-tabs { display: flex; }

  .mode-tabs label {
    flex: 1;
    text-align: center;
    padding: 8px 4px;
    font-size: 0.68rem;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    border: 1px solid var(--border);
    cursor: pointer;
    transition: all 0.2s;
    color: var(--text-dim);
    user-select: none;
  }

  .mode-tabs label:first-child { border-right: none; }
  .mode-tabs input[type="radio"] { display: none; }
  .mode-tabs label:has(input:checked) {
    color: var(--accent-bright);
    background: rgba(200,146,42,0.12);
    border-color: var(--accent-dim);
  }
  .mode-tabs label:hover { color: var(--text); background: rgba(255,255,255,0.03); }

  /* ── CHECKBOXES ── */
  .checkbox-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; }

  .cb-label {
    display: flex;
    align-items: center;
    gap: 7px;
    font-size: 0.68rem;
    color: var(--text-dim);
    cursor: pointer;
    padding: 5px 7px;
    border: 1px solid var(--border);
    transition: all 0.15s;
    user-select: none;
  }

  .cb-label:hover { color: var(--text); border-color: var(--border-bright); }
  .cb-label input[type="checkbox"] { display: none; }

  .cb-box {
    width: 12px; height: 12px;
    border: 1px solid var(--text-dim);
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0;
    transition: all 0.15s;
  }

  .cb-label:has(input:checked) .cb-box { background: var(--accent); border-color: var(--accent-bright); }
  .cb-label:has(input:checked) { color: var(--text-bright); border-color: var(--accent-dim); }
  .cb-label:has(input:checked) .cb-box::after { content: '✓'; font-size: 9px; color: var(--bg); line-height: 1; }

  /* ── DISTANCE TABLE ── */
  .dist-input-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.7rem;
    margin-top: 2px;
  }

  .dist-input-table th {
    font-size: 0.57rem;
    letter-spacing: 0.2em;
    color: var(--accent);
    text-align: left;
    padding: 4px 6px 7px;
    text-transform: uppercase;
    border-bottom: 1px solid var(--border);
    font-weight: normal;
  }

  .dist-input-table td { padding: 3px 3px; border-bottom: 1px solid rgba(46,53,40,0.4); }
  .dist-input-table tr:last-child td { border-bottom: none; }

  .dist-input-table input[type="number"] {
    width: 100%;
    font-size: 0.76rem;
    padding: 4px 7px;
    text-align: center;
  }

  .dist-id {
    color: var(--accent-bright);
    font-weight: bold;
    text-align: center;
    width: 34px;
    padding-left: 4px !important;
  }

  .dist-use { width: 38px; text-align: center; }

  .dist-toggle {
    width: 16px; height: 16px;
    border: 1px solid var(--text-dim);
    display: inline-flex; align-items: center; justify-content: center;
    cursor: pointer;
    background: var(--bg);
    font-size: 10px;
    color: transparent;
    transition: all 0.15s;
    user-select: none;
    margin: auto;
  }

  .dist-toggle.active { background: var(--accent); border-color: var(--accent-bright); color: var(--bg); }

  .dist-note {
    font-size: 0.6rem;
    color: var(--text-dim);
    margin-top: 8px;
    line-height: 1.55;
  }

  /* ── MATCH PANEL ── */
  #matchPanel.hidden { opacity: 0.3; pointer-events: none; }

  /* ── GENERATE BUTTON ── */
  .gen-btn {
    background: var(--accent);
    color: var(--bg);
    border: none;
    font-family: 'Barlow Condensed', sans-serif;
    font-weight: 900;
    font-size: 1.05rem;
    letter-spacing: 0.25em;
    text-transform: uppercase;
    padding: 13px 20px;
    cursor: pointer;
    width: 100%;
    position: relative;
    overflow: hidden;
    transition: background 0.2s, transform 0.1s;
    margin-top: 6px;
  }

  .gen-btn:hover { background: var(--accent-bright); }
  .gen-btn:active { transform: scale(0.98); background: var(--accent-dim); }

  .gen-btn::before {
    content: '';
    position: absolute; inset: 0;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.15), transparent);
    transform: translateX(-100%);
    transition: transform 0.4s;
  }

  .gen-btn:hover::before { transform: translateX(100%); }

  /* ── OUTPUT AREA ── */
  .output-area {
    padding: 22px;
    overflow-y: auto;
    max-height: calc(100vh - 84px);
  }

  .empty-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    min-height: 420px;
    color: var(--text-dim);
    font-size: 0.68rem;
    letter-spacing: 0.2em;
    gap: 20px;
    opacity: 0.42;
  }

  .empty-reticle {
    width: 76px; height: 76px;
    border: 1px solid currentColor;
    border-radius: 50%;
    position: relative;
    display: flex; align-items: center; justify-content: center;
  }

  .empty-reticle::before, .empty-reticle::after { content: ''; position: absolute; background: currentColor; }
  .empty-reticle::before { width: 1px; height: 100%; }
  .empty-reticle::after  { width: 100%; height: 1px; }

  /* ── STAGE CARDS ── */
  .stage-card {
    background: var(--surface);
    border: 1px solid var(--border);
    margin-bottom: 14px;
    animation: fadeIn 0.4s ease forwards;
    opacity: 0;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(8px); }
    to   { opacity: 1; transform: translateY(0); }
  }

  .stage-header {
    background: var(--surface2);
    border-bottom: 1px solid var(--border);
    padding: 9px 16px;
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .stage-num {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 1.25rem;
    font-weight: 900;
    color: var(--accent-bright);
    letter-spacing: 0.1em;
    min-width: 80px;
  }

  .stage-meta { display: flex; gap: 20px; margin-left: auto; }

  .meta-item { font-size: 0.62rem; letter-spacing: 0.15em; color: var(--text-dim); }
  .meta-item span { color: var(--accent2-bright); font-size: 0.82rem; }

  .stage-body { padding: 16px; display: grid; grid-template-columns: auto 1fr; gap: 20px; }

  .target-table { border-collapse: collapse; font-size: 0.7rem; }

  .target-table th {
    font-size: 0.57rem;
    letter-spacing: 0.2em;
    color: var(--accent);
    text-align: left;
    padding: 4px 14px 7px 0;
    text-transform: uppercase;
    border-bottom: 1px solid var(--border);
    font-weight: normal;
  }

  .target-table td { padding: 5px 14px 5px 0; border-bottom: 1px solid rgba(46,53,40,0.5); color: var(--text); }
  .target-table td:first-child { color: var(--accent-bright); font-weight: bold; }
  .target-table tr:last-child td { border-bottom: none; }

  .cof-section { border-left: 1px solid var(--border); padding-left: 18px; }

  .cof-label { font-size: 0.58rem; letter-spacing: 0.25em; color: var(--accent); text-transform: uppercase; margin-bottom: 10px; }

  .position-block { margin-bottom: 12px; }
  .position-name { font-size: 0.62rem; letter-spacing: 0.18em; color: var(--accent2-bright); text-transform: uppercase; margin-bottom: 5px; }
  .shot-sequence { display: flex; flex-wrap: wrap; gap: 4px; align-items: center; }

  .shot-chip {
    background: rgba(200,146,42,0.1);
    border: 1px solid var(--accent-dim);
    color: var(--accent-bright);
    padding: 3px 8px;
    font-size: 0.7rem;
  }

  .shot-arrow { color: var(--text-dim); font-size: 0.68rem; }

  /* ── HELP MODAL ── */
  .modal-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.88);
    z-index: 9999;
    align-items: flex-start;
    justify-content: center;
    padding: 30px 20px 50px;
    overflow-y: auto;
  }

  .modal-overlay.open { display: flex; }

  .modal {
    background: var(--surface);
    border: 1px solid var(--border-bright);
    border-top: 2px solid var(--accent);
    max-width: 800px;
    width: 100%;
    animation: fadeIn 0.25s ease;
  }

  .modal-header {
    background: var(--surface2);
    border-bottom: 1px solid var(--border);
    padding: 14px 20px;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .modal-title {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 1.2rem;
    font-weight: 900;
    letter-spacing: 0.15em;
    color: var(--accent-bright);
    text-transform: uppercase;
  }

  .modal-close {
    background: transparent;
    border: 1px solid var(--border);
    color: var(--text-dim);
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.7rem;
    letter-spacing: 0.1em;
    padding: 5px 12px;
    cursor: pointer;
    transition: all 0.2s;
  }

  .modal-close:hover { border-color: var(--red-bright); color: var(--red-bright); }

  .modal-body { padding: 22px 24px; }

  .help-section { margin-bottom: 28px; }
  .help-section:last-child { margin-bottom: 0; }

  .help-section-title {
    font-size: 0.6rem;
    letter-spacing: 0.3em;
    color: var(--accent);
    text-transform: uppercase;
    margin-bottom: 12px;
    padding-bottom: 7px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .help-section-title span { color: var(--accent-bright); font-size: 0.85rem; }

  .help-p { font-size: 0.72rem; color: var(--text); line-height: 1.72; margin-bottom: 10px; }
  .help-p:last-child { margin-bottom: 0; }

  .help-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

  .help-card { background: var(--surface2); border: 1px solid var(--border); padding: 12px 14px; }

  .help-card-title {
    font-size: 0.62rem;
    color: var(--accent-bright);
    letter-spacing: 0.15em;
    text-transform: uppercase;
    margin-bottom: 7px;
  }

  .help-card p { font-size: 0.68rem; color: var(--text-dim); line-height: 1.62; }
  .help-card p strong { color: var(--text); }

  .help-table { width: 100%; border-collapse: collapse; font-size: 0.68rem; }

  .help-table th {
    font-size: 0.57rem;
    letter-spacing: 0.2em;
    color: var(--accent);
    text-align: left;
    padding: 5px 12px 7px 0;
    border-bottom: 1px solid var(--border);
    font-weight: normal;
    text-transform: uppercase;
  }

  .help-table td {
    padding: 7px 12px 7px 0;
    border-bottom: 1px solid rgba(46,53,40,0.4);
    color: var(--text-dim);
    vertical-align: top;
    line-height: 1.58;
  }

  .help-table td:first-child { color: var(--accent-bright); white-space: nowrap; min-width: 120px; }
  .help-table tr:last-child td { border-bottom: none; }

  .badge {
    display: inline-block;
    padding: 2px 7px;
    font-size: 0.57rem;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    border: 1px solid;
    margin-left: 6px;
    vertical-align: middle;
  }

  .badge-club     { color: var(--accent2-bright); border-color: var(--accent2); }
  .badge-regional { color: var(--accent-bright); border-color: var(--accent-dim); }
  .badge-national { color: var(--red-bright);   border-color: var(--red); }

  .modal-footer {
    background: var(--surface2);
    border-top: 1px solid var(--border);
    padding: 11px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 10px;
  }

  .modal-footer-text { font-size: 0.62rem; color: var(--text-dim); letter-spacing: 0.1em; }
  .modal-footer-text strong { color: var(--text); }


  /* ── THEME SWITCHER ── */
  .theme-switcher {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 4px;
  }

  .theme-switcher-label {
    font-size: 0.54rem;
    letter-spacing: 0.25em;
    color: var(--text-dim);
  }

  .theme-btns { display: flex; gap: 4px; }

  .theme-btn {
    display: flex;
    align-items: center;
    gap: 5px;
    background: transparent;
    border: 1px solid var(--border);
    color: var(--text-dim);
    font-family: "Share Tech Mono", monospace;
    font-size: 0.6rem;
    letter-spacing: 0.15em;
    padding: 4px 9px;
    cursor: pointer;
    transition: all 0.2s;
    white-space: nowrap;
  }

  .theme-btn:hover {
    border-color: var(--border-bright);
    color: var(--text);
  }

  .theme-btn.active {
    border-color: var(--accent-dim);
    color: var(--accent-bright);
    background: rgba(0,0,0,0.3);
  }

  .theme-swatch {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    flex-shrink: 0;
    display: inline-block;
  }

  /* ── SCROLLBAR ── */
  ::-webkit-scrollbar { width: 6px; }
  ::-webkit-scrollbar-track { background: var(--bg); }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
  ::-webkit-scrollbar-thumb:hover { background: var(--border-bright); }

  /* ── RESPONSIVE ── */
  @media (max-width: 820px) {
    .main-grid { grid-template-columns: 1fr; }
    .sidebar, .output-area { max-height: none; }
    .stage-body { grid-template-columns: 1fr; }
    .cof-section { border-left: none; border-top: 1px solid var(--border); padding-left: 0; padding-top: 14px; }
    .header-status { display: none; }
    .help-grid { grid-template-columns: 1fr; }
  }
</style>
</head>
<body>

<!-- ═══════════════════ HELP MODAL ═══════════════════ -->
<div class="modal-overlay" id="helpModal" onclick="closeHelpOnBg(event)">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">◈ Documentation &amp; Reference</div>
      <button class="modal-close" onclick="closeHelp()">✕ CLOSE</button>
    </div>

    <div class="modal-body">

      <!-- OVERVIEW -->
      <div class="help-section">
        <div class="help-section-title"><span>◆</span> Overview</div>
        <p class="help-p">The PRS Stage &amp; Match Builder generates randomized Precision Rifle Series stage and match plans based on your range setup, equipment availability, and difficulty preferences. Use it to design training scenarios, club stages, or full match cards with realistic engagement sequences, positional splits, and time constraints.</p>
      </div>

      <!-- MODES -->
      <div class="help-section">
        <div class="help-section-title"><span>◆</span> Modes</div>
        <div class="help-grid">
          <div class="help-card">
            <div class="help-card-title">Single Stage</div>
            <p>Generates one stage based on your current settings. Ideal for individual training drills, testing specific positional skills, or prototyping a stage before adding it to a match. All configuration settings apply directly to the single stage output.</p>
          </div>
          <div class="help-card">
            <div class="help-card-title">Match Mode</div>
            <p>Generates a full multi-stage match card. Set the number of stages and overall difficulty level in the Match Settings panel. Each stage is independently randomized using the same global range parameters and equipment pool, ensuring variety across the card.</p>
          </div>
        </div>
      </div>

      <!-- RANGE PARAMETERS -->
      <div class="help-section">
        <div class="help-section-title"><span>◆</span> Range Parameters &amp; Distance Table</div>
        <p class="help-p"><strong>Min / Max Distance</strong> — Define the yardage window available at your range. Random target distances will be drawn from within this band. The builder distributes targets evenly across the full spread.</p>
        <p class="help-p"><strong>Target Distance Table</strong> — Allows you to specify exact yardages for individual target slots. Toggle the checkmark in the USE column to lock a specific distance into that target slot. Locked distances override the random generator for that slot only. Unlocked slots continue to use random distances within your Min/Max band. This is particularly useful when your range has fixed steel positions at known yardages.</p>
        <p class="help-p">The distance table updates automatically when Target Count changes, preserving any values you have already entered.</p>
      </div>

      <!-- STAGE CONFIGURATION -->
      <div class="help-section">
        <div class="help-section-title"><span>◆</span> Stage Configuration</div>
        <table class="help-table">
          <thead><tr><th>Setting</th><th>Description</th></tr></thead>
          <tbody>
            <tr>
              <td>Target Count</td>
              <td>Number of steel targets in the stage (1–10). Each target receives a randomized distance (unless locked), a plate size based on focus, and a round allocation.</td>
            </tr>
            <tr>
              <td>Focus — Balanced</td>
              <td>Pulls plate sizes from the full MOA/MIL options pool. Best for general-purpose stages with varied challenge.</td>
            </tr>
            <tr>
              <td>Focus — Wind</td>
              <td>Biases toward mid-size plates at longer distances where horizontal wind drift is the dominant accuracy challenge.</td>
            </tr>
            <tr>
              <td>Focus — Elevation</td>
              <td>Selects mid-to-large plates with an emphasis on stages where vertical hold is the primary difficulty — useful for valley or hillside ranges.</td>
            </tr>
            <tr>
              <td>Focus — Small Target</td>
              <td>Restricts plate sizes to the smallest two options in the pool. Maximum accuracy demand; recommended for advanced shooters only.</td>
            </tr>
            <tr>
              <td>Focus — Combined</td>
              <td>Unrestricted random size selection across the entire pool. Greatest variety; simulates unpredictable match conditions.</td>
            </tr>
            <tr>
              <td>Round Mode — Full</td>
              <td>10–12 rounds, 105 second time limit, up to 3 positions. Competition-standard complexity. Tests round management, position transitions, and sustained accuracy under time pressure.</td>
            </tr>
            <tr>
              <td>Round Mode — Mid Compression</td>
              <td>6–8 rounds, 75–90 seconds, 2 positions. A balanced format that rewards efficient position setup and clean shot execution over brute speed.</td>
            </tr>
            <tr>
              <td>Round Mode — Low Compression</td>
              <td>4–6 rounds, 45–60 seconds, 1 position. Fast and decisive. Favors cold-bore first-round hit capability and rapid target acquisition. Ideal for speed drills.</td>
            </tr>
            <tr>
              <td>Units</td>
              <td>Display plate sizes in <strong>MOA</strong> (Minutes of Angle) or <strong>MIL</strong> (Milliradians) to match your scope's reticle and turret system.</td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- EQUIPMENT -->
      <div class="help-section">
        <div class="help-section-title"><span>◆</span> Equipment &amp; Positions</div>
        <p class="help-p">Select all positional props available at your range. The builder randomly assigns positions from this pool based on round mode — Full uses up to 3 positions, Mid uses 2, and Low uses 1. At least one piece of equipment must be selected; the builder defaults to Barricade + Prone if none are checked.</p>
        <table class="help-table">
          <thead><tr><th>Position</th><th>Description</th></tr></thead>
          <tbody>
            <tr><td>Barricade</td><td>Vertical structure for standing, kneeling, or squatting supported shots. The most common PRS stage prop.</td></tr>
            <tr><td>Tripod</td><td>Three-legged field support. Requires deliberate deployment; often paired with standing or high kneeling positions at extended range.</td></tr>
            <tr><td>Tank Trap</td><td>X-shaped steel obstacle offering unconventional supported positions. Tests rifle handling, contact point selection, and body geometry.</td></tr>
            <tr><td>Rooftop</td><td>Elevated platform or simulated structure. Adds vertical engagement angles and challenges stability at height.</td></tr>
            <tr><td>Prone</td><td>Traditional flat-ground prone position. Lowest profile and highest natural stability — the baseline for any rifleman.</td></tr>
            <tr><td>Modified Prone</td><td>Elevated prone over a low obstacle, short bag stack, or terrain feature. Common in field-style and positional stages.</td></tr>
          </tbody>
        </table>
      </div>

      <!-- MATCH DIFFICULTY -->
      <div class="help-section">
        <div class="help-section-title"><span>◆</span> Match Difficulty</div>
        <p class="help-p">Match difficulty defines the overall tier of a generated match and is intended to guide stage design intent for match directors. The builder uses this setting as a reference level — future versions will modulate plate sizes, distances, and time limits automatically based on the selected tier.</p>
        <table class="help-table">
          <thead><tr><th>Level</th><th>Intended Use &amp; Design Guidelines</th></tr></thead>
          <tbody>
            <tr>
              <td>Club <span class="badge badge-club">Beginner</span></td>
              <td>Entry-level match format. Shorter distances (150–500 yd), larger plate sizes (2–4 MOA / 0.7–1.2 MIL), generous time limits, and simpler positions (barricade, prone). Designed to introduce new competitors to stage format, position deployment, and time management without overwhelming them. Recommended stage count: 4–6.</td>
            </tr>
            <tr>
              <td>Regional <span class="badge badge-regional">Intermediate</span></td>
              <td>Mid-tier competitive format. Engagements at 300–700 yd, mixed plate sizes (1–3 MOA / 0.3–0.7 MIL), moderate time pressure, 2-position stages common. Assumes familiarity with positional shooting, wind reading at distance, and basic ballistic compensation. Recommended stage count: 6–10.</td>
            </tr>
            <tr>
              <td>National <span class="badge badge-national">Expert</span></td>
              <td>High-level competition format. Extended ranges (600–1000+ yd), small plate emphasis (0.5–1.5 MOA / 0.2–0.5 MIL), compressed time windows (45–90 sec for many stages), and unconventional or stacked positions. Built for experienced competitors who can rapidly solve ballistic problems and maintain composure under time and positional stress. Recommended stage count: 10–16.</td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- READING OUTPUT -->
      <div class="help-section">
        <div class="help-section-title"><span>◆</span> Reading the Stage Output</div>
        <table class="help-table">
          <thead><tr><th>Field</th><th>Meaning</th></tr></thead>
          <tbody>
            <tr><td>Time Limit</td><td>Total seconds to expend all allocated rounds across all positions in the stage.</td></tr>
            <tr><td>Total Rds</td><td>Total rounds to be fired in the stage, distributed across all targets.</td></tr>
            <tr><td>Positions</td><td>Number of distinct prop or position changes required within the stage.</td></tr>
            <tr><td>Dist</td><td>Target engagement distance in yards. If a distance was locked in the distance table, that value is used directly.</td></tr>
            <tr><td>Size</td><td>Target plate angular size in MOA or MIL. Smaller values are harder at any given distance.</td></tr>
            <tr><td>Rds</td><td>Total rounds allocated to that specific target across all positions in the stage.</td></tr>
            <tr><td>Course of Fire</td><td>Per-position engagement sequence. Arrows (›) indicate shot order. The sequence is randomized to avoid consecutive shots on the same target where possible.</td></tr>
          </tbody>
        </table>
      </div>

    </div><!-- /modal-body -->

    <div class="modal-footer">
      <div class="modal-footer-text">PRS Stage &amp; Match Builder // <strong>BUILD v2.1</strong></div>
      <div class="modal-footer-text">Author: <strong>Charles Witherspoon</strong></div>
    </div>
  </div>
</div>

<!-- ═══════════════════ HEADER ═══════════════════ -->
<header>
  <div class="header-inner">
    <div class="reticle">
      <svg viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
        <circle cx="24" cy="24" r="22" stroke="#c8922a" stroke-width="1"/>
        <circle cx="24" cy="24" r="12" stroke="#c8922a" stroke-width="0.75" stroke-dasharray="3 3"/>
        <circle cx="24" cy="24" r="3" stroke="#e8a832" stroke-width="1.5"/>
        <line x1="24" y1="0" x2="24" y2="16" stroke="#c8922a" stroke-width="1"/>
        <line x1="24" y1="32" x2="24" y2="48" stroke="#c8922a" stroke-width="1"/>
        <line x1="0" y1="24" x2="16" y2="24" stroke="#c8922a" stroke-width="1"/>
        <line x1="32" y1="24" x2="48" y2="24" stroke="#c8922a" stroke-width="1"/>
        <line x1="20" y1="4" x2="22" y2="4" stroke="#c8922a" stroke-width="0.75"/>
        <line x1="26" y1="4" x2="28" y2="4" stroke="#c8922a" stroke-width="0.75"/>
        <line x1="20" y1="44" x2="22" y2="44" stroke="#c8922a" stroke-width="0.75"/>
        <line x1="26" y1="44" x2="28" y2="44" stroke="#c8922a" stroke-width="0.75"/>
      </svg>
    </div>
    <div class="header-text">
      <h1>PRS Stage Builder</h1>
      <p>PRECISION RIFLE SERIES // MATCH &amp; STAGE GENERATOR</p>
    </div>
    <div class="header-right">
      <div class="theme-switcher">
        <div class="theme-switcher-label">THEME</div>
        <div class="theme-btns">
          <button class="theme-btn active" data-theme="amber" onclick="setTheme('amber')" title="Amber Tactical">
            <span class="theme-swatch" style="background:#e8a832"></span>
            <span>AMBER</span>
          </button>
          <button class="theme-btn" data-theme="nvg" onclick="setTheme('nvg')" title="Night Vision Green">
            <span class="theme-swatch" style="background:#39ff39"></span>
            <span>NVG</span>
          </button>
          <button class="theme-btn" data-theme="day" onclick="setTheme('day')" title="Daytime">
            <span class="theme-swatch" style="background:#ffffff; border:1px solid #aaa"></span>
            <span>DAY</span>
          </button>
        </div>
      </div>
      <button class="help-btn" onclick="openHelp()">? HELP &amp; DOCS</button>
      <div class="header-status">
        <div><span class="status-dot"></span>SYSTEM READY</div>
        <div>BUILD v2.1</div>
        <div style="font-size:0.58rem; margin-top:1px;">C. WITHERSPOON</div>
      </div>
    </div>
  </div>
</header>

<!-- ═══════════════════ MAIN GRID ═══════════════════ -->
<div class="main-grid">

  <!-- ── SIDEBAR ── -->
  <aside class="sidebar">

    <!-- MODE -->
    <div class="panel">
      <div class="panel-label">Mode Select</div>
      <div class="mode-tabs">
        <label><input type="radio" name="mode" value="single" checked onchange="updateMode()"><span>Single Stage</span></label>
        <label><input type="radio" name="mode" value="match" onchange="updateMode()"><span>Match Mode</span></label>
      </div>
    </div>

    <!-- RANGE -->
    <div class="panel">
      <div class="panel-label">Range Parameters</div>
      <div class="field-row">
        <label class="field-label">MIN DISTANCE (YD)</label>
        <input type="number" id="minDist" value="400" min="50" max="2000">
      </div>
      <div class="field-row">
        <label class="field-label">MAX DISTANCE (YD)</label>
        <input type="number" id="maxDist" value="800" min="50" max="2000">
      </div>
    </div>

    <!-- STAGE CONFIG -->
    <div class="panel">
      <div class="panel-label">Stage Configuration</div>
      <div class="field-row">
        <label class="field-label">TARGET COUNT</label>
        <input type="number" id="targetCount" value="4" min="1" max="10" onchange="rebuildDistTable()">
      </div>
      <div class="field-row">
        <label class="field-label">FOCUS</label>
        <select id="focus">
          <option value="balanced">Balanced</option>
          <option value="wind">Wind</option>
          <option value="elevation">Elevation</option>
          <option value="small">Small Target</option>
          <option value="combined">Combined</option>
        </select>
      </div>
      <div class="field-row">
        <label class="field-label">ROUND MODE</label>
        <select id="roundMode">
          <option value="full">Full</option>
          <option value="mid">Mid Compression</option>
          <option value="low">Low Compression</option>
        </select>
      </div>
      <div class="field-row">
        <label class="field-label">UNITS</label>
        <select id="units">
          <option value="MOA">MOA</option>
          <option value="MIL">MIL</option>
        </select>
      </div>
    </div>

    <!-- TARGET DISTANCE TABLE -->
    <div class="panel">
      <div class="panel-label">Target Distances (yd)</div>
      <table class="dist-input-table">
        <thead>
          <tr>
            <th>TGT</th>
            <th>DISTANCE (YD)</th>
            <th style="text-align:center">USE</th>
          </tr>
        </thead>
        <tbody id="distTableBody"></tbody>
      </table>
      <div class="dist-note">Toggle ✓ to lock a distance. Unlocked slots use random values within range parameters.</div>
    </div>

    <!-- EQUIPMENT -->
    <div class="panel">
      <div class="panel-label">Equipment</div>
      <div class="checkbox-grid">
        <label class="cb-label"><input type="checkbox" value="Barricade" checked><span class="cb-box"></span>Barricade</label>
        <label class="cb-label"><input type="checkbox" value="Tripod"><span class="cb-box"></span>Tripod</label>
        <label class="cb-label"><input type="checkbox" value="Tank Trap"><span class="cb-box"></span>Tank Trap</label>
        <label class="cb-label"><input type="checkbox" value="Rooftop"><span class="cb-box"></span>Rooftop</label>
        <label class="cb-label"><input type="checkbox" value="Prone"><span class="cb-box"></span>Prone</label>
        <label class="cb-label"><input type="checkbox" value="Modified Prone"><span class="cb-box"></span>Mod. Prone</label>
      </div>
    </div>

    <!-- MATCH SETTINGS -->
    <div class="panel" id="matchPanel">
      <div class="panel-label">Match Settings</div>
      <div class="field-row">
        <label class="field-label">STAGE COUNT</label>
        <input type="number" id="stageCount" value="8" min="1" max="20">
      </div>
      <div class="field-row">
        <label class="field-label">DIFFICULTY</label>
        <select id="difficulty">
          <option value="club">Club</option>
          <option value="regional">Regional</option>
          <option value="national">National</option>
        </select>
      </div>
    </div>

    <button class="gen-btn" onclick="generate()">▶ GENERATE</button>

  </aside>

  <!-- ── OUTPUT ── -->
  <main class="output-area">
    <div class="empty-state" id="emptyState">
      <div class="empty-reticle"></div>
      <div>AWAITING STAGE GENERATION</div>
    </div>
    <div id="output"></div>
  </main>

</div>

<!-- ═══════════════════ SCRIPT ═══════════════════ -->
<script>
  const MOA_OPTIONS = [0.5, 1, 1.5, 2, 3, 4];

  /* ── theme ── */
  function setTheme(theme) {
    document.documentElement.setAttribute('data-theme', theme);
    document.querySelectorAll('.theme-btn').forEach(btn => {
      btn.classList.toggle('active', btn.dataset.theme === theme);
    });
    // Update reticle SVG colors per theme
    const reticleParts = document.querySelectorAll('.reticle svg circle, .reticle svg line');
    if (theme === 'nvg') {
      reticleParts.forEach(el => {
        if (el.getAttribute('stroke') === '#e8a832' || el.getAttribute('stroke') === '#000000') el.setAttribute('stroke', '#39ff39');
        else el.setAttribute('stroke', '#00c800');
      });
    } else if (theme === 'day') {
      reticleParts.forEach(el => {
        el.setAttribute('stroke', el.getAttribute('stroke-width') === '1.5' ? '#000000' : '#333333');
      });
    } else {
      reticleParts.forEach(el => {
        if (el.getAttribute('stroke') === '#39ff39' || el.getAttribute('stroke') === '#000000' || el.getAttribute('stroke') === '#333333') {
          el.setAttribute('stroke', el.getAttribute('stroke-width') === '1.5' ? '#e8a832' : '#c8922a');
        } else {
          el.setAttribute('stroke', '#c8922a');
        }
      });
    }
    try { localStorage.setItem('prs-theme', theme); } catch(e) {}
  }
  const MIL_OPTIONS = [0.2, 0.3, 0.5, 0.7, 1.0, 1.2];

  /* ── utils ── */
  const rand    = (mn, mx) => Math.random() * (mx - mn) + mn;
  const randInt = (mn, mx) => Math.floor(rand(mn, mx));
  const shuffle = arr => [...arr].sort(() => Math.random() - 0.5);

  /* ── help modal ── */
  function openHelp()  { document.getElementById('helpModal').classList.add('open'); }
  function closeHelp() { document.getElementById('helpModal').classList.remove('open'); }
  function closeHelpOnBg(e) { if (e.target === document.getElementById('helpModal')) closeHelp(); }

  /* ── mode ── */
  function updateMode() {
    const isMatch = document.querySelector('input[name="mode"]:checked').value === 'match';
    document.getElementById('matchPanel').classList.toggle('hidden', !isMatch);
  }

  /* ── distance table ── */
  function rebuildDistTable() {
    const count = Math.max(1, Math.min(10, parseInt(document.getElementById('targetCount').value) || 4));
    const tbody = document.getElementById('distTableBody');

    // Preserve existing row values
    const prev = Array.from(tbody.querySelectorAll('tr')).map(tr => ({
      val: tr.querySelector('input').value,
      active: tr.querySelector('.dist-toggle').classList.contains('active')
    }));

    tbody.innerHTML = '';
    for (let i = 0; i < count; i++) {
      const p = prev[i] || { val: '', active: false };
      const tr = document.createElement('tr');
      tr.innerHTML =
        `<td class="dist-id">T${i + 1}</td>` +
        `<td><input type="number" min="50" max="2000" placeholder="random" value="${p.val}"></td>` +
        `<td class="dist-use"><div class="dist-toggle${p.active ? ' active' : ''}" onclick="toggleDist(this)">${p.active ? '✓' : ''}</div></td>`;
      tbody.appendChild(tr);
    }
  }

  function toggleDist(el) {
    el.classList.toggle('active');
    el.textContent = el.classList.contains('active') ? '✓' : '';
  }

  function getLockedDistances() {
    return Array.from(document.querySelectorAll('#distTableBody tr')).map(tr => {
      const active = tr.querySelector('.dist-toggle').classList.contains('active');
      const val    = parseInt(tr.querySelector('input').value);
      return (active && val > 0) ? val : null;
    });
  }

  /* ── stage logic ── */
  function generateDistances(min, max, count, locked) {
    return locked.map(l => l !== null ? l : Math.round(rand(min, max)));
  }

  function pickPlate(focus, units) {
    const options = units === 'MOA' ? MOA_OPTIONS : MIL_OPTIONS;
    let pool = [...options];
    if (focus === 'small')     pool = options.slice(0, 2);
    if (focus === 'elevation') pool = options.slice(1, 4);
    if (focus === 'wind')      pool = options.slice(1, 3);
    return pool[randInt(0, pool.length)];
  }

  function getRoundProfile(mode) {
    if (mode === 'full') return { rounds: randInt(10, 13), time: 105 };
    if (mode === 'mid')  return { rounds: randInt(6, 9),  time: randInt(75, 91) };
    return                      { rounds: randInt(4, 7),  time: randInt(45, 61) };
  }

  function allocateRounds(targets, total) {
    const alloc = targets.map(t => ({ ...t, rounds: 0 }));
    let rem = total;
    for (let i = 0; i < alloc.length && rem > 0; i++, rem--) alloc[i].rounds++;
    while (rem > 0) { alloc[randInt(0, alloc.length)].rounds++; rem--; }
    return alloc;
  }

  function buildEngagementSequence(targets) {
    let pool = [];
    targets.forEach(t => { for (let i = 0; i < t.rounds; i++) pool.push(t.id); });
    pool = shuffle(pool);
    for (let i = 1; i < pool.length; i++) {
      if (pool[i] === pool[i - 1]) {
        const swap = pool.findIndex((v, j) => j > i && v !== pool[i]);
        if (swap > i) [pool[i], pool[swap]] = [pool[swap], pool[i]];
      }
    }
    return pool;
  }

  function splitAcrossPositions(seq, positions) {
    const perPos = Math.floor(seq.length / positions.length);
    const rem    = seq.length % positions.length;
    let idx = 0;
    return positions.map((_, i) => {
      const count = perPos + (i === positions.length - 1 ? rem : 0);
      const slice = seq.slice(idx, idx + count);
      idx += count;
      return slice;
    });
  }

  function buildStage(globalMin, globalMax) {
    const targetCount = parseInt(document.getElementById('targetCount').value);
    const focus       = document.getElementById('focus').value;
    const roundMode   = document.getElementById('roundMode').value;
    const units       = document.getElementById('units').value;
    let equipment     = Array.from(document.querySelectorAll('input[type=checkbox]:checked')).map(e => e.value);
    if (!equipment.length) equipment = ['Barricade', 'Prone'];

    // Build locked distance array padded to targetCount
    const locked = getLockedDistances().slice(0, targetCount);
    while (locked.length < targetCount) locked.push(null);

    const distances = generateDistances(globalMin, globalMax, targetCount, locked);
    let targets = distances.map((d, i) => ({ id: 'T' + (i + 1), distance: d, size: pickPlate(focus, units) }));
    targets = shuffle(targets);

    const roundProfile    = getRoundProfile(roundMode);
    const allocated       = allocateRounds(targets, roundProfile.rounds);
    const engagementOrder = buildEngagementSequence(allocated);

    const posCount  = roundMode === 'full' ? 3 : (roundMode === 'mid' ? 2 : 1);
    const positions = shuffle(equipment).slice(0, Math.min(posCount, equipment.length));
    const split     = splitAcrossPositions(engagementOrder, positions);

    return { targets: allocated, split, positions, totalRounds: roundProfile.rounds, time: roundProfile.time, units };
  }

  /* ── render ── */
  function renderStage(stage, index = null) {
    const title = index !== null ? `STAGE ${String(index + 1).padStart(2, '0')}` : 'SINGLE STAGE';
    const delay = (index || 0) * 70;

    let h = `<div class="stage-card" style="animation-delay:${delay}ms">`;

    h += `<div class="stage-header">
      <div class="stage-num">${title}</div>
      <div class="stage-meta">
        <div class="meta-item">TIME LIMIT<br><span>${stage.time}s</span></div>
        <div class="meta-item">TOTAL RDS<br><span>${stage.totalRounds}</span></div>
        <div class="meta-item">POSITIONS<br><span>${stage.positions.length}</span></div>
      </div>
    </div>`;

    h += `<div class="stage-body"><div>`;
    h += `<table class="target-table"><thead><tr><th>TGT</th><th>DIST</th><th>SIZE</th><th>RDS</th></tr></thead><tbody>`;
    stage.targets.forEach(t => {
      h += `<tr><td>${t.id}</td><td>${t.distance}yd</td><td>${t.size} ${stage.units}</td><td>${t.rounds}</td></tr>`;
    });
    h += `</tbody></table></div>`;

    h += `<div class="cof-section"><div class="cof-label">Course of Fire</div>`;
    stage.positions.forEach((pos, i) => {
      const shots = stage.split[i];
      h += `<div class="position-block"><div class="position-name">◆ ${pos}</div><div class="shot-sequence">`;
      shots.forEach((s, j) => {
        h += `<div class="shot-chip">${s}</div>`;
        if (j < shots.length - 1) h += `<span class="shot-arrow">›</span>`;
      });
      h += `</div></div>`;
    });
    h += `</div></div></div>`;
    return h;
  }

  /* ── generate ── */
  function generate() {
    const mode      = document.querySelector('input[name="mode"]:checked').value;
    const globalMin = parseInt(document.getElementById('minDist').value);
    const globalMax = parseInt(document.getElementById('maxDist').value);

    if (globalMin >= globalMax) { alert('MIN distance must be less than MAX distance.'); return; }

    document.getElementById('emptyState').style.display = 'none';
    let output = '';

    if (mode === 'single') {
      output = renderStage(buildStage(globalMin, globalMax));
    } else {
      const stageCount = parseInt(document.getElementById('stageCount').value);
      for (let i = 0; i < stageCount; i++) output += renderStage(buildStage(globalMin, globalMax), i);
    }

    document.getElementById('output').innerHTML = output;
  }

  /* ── init ── */
  updateMode();
  rebuildDistTable();
  // Restore saved theme
  try {
    const saved = localStorage.getItem('prs-theme');
    if (saved && saved !== 'amber') setTheme(saved);
  } catch(e) {}
</script>
</body>
</html>
